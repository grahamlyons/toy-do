language: node_js
node_js:
- node
jobs:
  include:
  - stage: test
    name: Unit Tests
    script: npm test
  - stage: test
    name: Linting
    script: npm run lint
  - stage: build
    name: Build container
    install: skip
    script: |
      docker image build -t "registry.heroku.com/toy-do/web:${TRAVIS_BUILD_NUMBER}" .
      echo "${HEROKU_API_KEY}" | docker login --username=_ --password-stdin registry.heroku.com
      docker image push "registry.heroku.com/toy-do/web:${TRAVIS_BUILD_NUMBER}"
  - stage: acceptance-tests
    name: Acceptance tests
    install: skip
    script: |
      export WEB_IMAGE="registry.heroku.com/toy-do/web:${TRAVIS_BUILD_NUMBER}"
      echo "${HEROKU_API_KEY}" | docker login --username=_ --password-stdin registry.heroku.com
      docker-compose run tests
  - stage: database
    if: branch = master
    name: Database migration
    script: |
      export NODE_ENV=production
      export $(heroku config:get --app toy-do --shell DATABASE_URL)
      npm run db:migrate
  - stage: deploy
    if: branch = master
    name: Deploy
    install: skip
    script: ./deploy.sh
  - stage: smoke-test
    if: branch = master
    name: Smoke test
    install: skip
    script: curl --silent --show-error --fail https://toy-do.herokuapp.com
env:
  global:
  - secure: O62xaqGrhf9OSv2lFgcdCaYyvkQgZIf1noVuuM6M3EE0SfVo7q+ZPEikM6LU7y1mnEke5H1QvU4eG9aoZLDkYFCWreK6kNXCGCugzNJEdqhqsCBOmGH81u6Cgioxky9T24znrbbiNQbrNgqbiLsI2JcfYgCiodJZdUyF3Cru0Thh7rb1VD+k0XfIbmfir6Nm0sS044f3Tk9FPsLgbhHIxU64+0/WeCRk7RWA4qXdXGJ9u5BqTPqYZjB/x68HylmLYPP+TlD/axuE9W6frE4Mv8GX8SuUSHmKNxC2vff+CpgGtcoXyuaabPYx3Dx5Xd8U18Z3vAqzmF/fOVwTxNtcWpv4XMhYQI/mteAOv/d+LtF7cKZTI72gcWSDwI66GQa04+msTMT752x4fveQOfgGOwZ+4u//EcavpBqUNdzU4o1h+ECOVxEUrpV04q0CXRWOBYoupXBEiy9YIQGCMWXG6dLRaTvTX3Fr6v8q2FhMdTz3acMsyucMqQufYSzTXpHnm+kYGFRM5hXMb2VMPRpCyUHxiv3jD/dyp4ykXRK5OcZ/wacbArtNP0YOL2ot9hET2oV7h8PWayeyYPUEfwRxlla2TPpcfq5Ub4uvCjknO0Nx54DtxdWpYkwNJB1q6CnOm4W1U81p9B79q1CiJoAPHJmeIuws9fEks17Z8pOMapU=
